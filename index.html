<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mulbum3D — Professional 3D Printing</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.paypal.com/sdk/js?client-id=AWlxRpEWuzvjdHyQ__cKpDgK7pj-qfWo8qGO9BkOlUq_TpiRoChpAdRWsuQp3TqDdH6R3iuql3LBWO_u&currency=GBP"></script>

<style>
  body {
    background: #000;
    color: #fff;
    font-family: sans-serif;
  }
  .card {
    background: rgba(20,20,20,0.9);
    border-radius: 1.5rem;
    padding: 2rem;
  }
  .input {
    background: #000;
    border: 1px solid #333;
    border-radius: 1rem;
    padding: 0.75rem;
    color: #fff;
    width: 100%;
  }
  .input:focus {
    outline: none;
    border-color: #f97316;
  }
  .upload-btn {
    background: #f97316;
    color: #000;
    border-radius: 1.5rem;
    padding: 1rem;
    font-weight: 700;
    text-align: center;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.2s ease;
    display: inline-block;
    width: 100%;
  }
  .upload-btn:hover {
    transform: scale(1.03);
    box-shadow: 0 0 40px rgba(255,140,0,0.9);
  }
  hr {
    border-color: rgba(255,140,0,0.5);
  }
</style>
</head>

<body class="min-h-screen flex justify-center p-6">

<div class="w-full max-w-3xl card space-y-8">

<header class="text-center space-y-3">
  <img src="logo.png" class="mx-auto h-20" />
  <h1 class="text-4xl font-extrabold">Professional 3D Printing</h1>
  <p class="text-gray-400">Fast · Precise · Affordable</p>
</header>

<section class="text-center text-sm text-gray-400">
  Pricing: <b>£0.02 / minute</b> · <b>£0.01 / gram PLA</b><br>
  Multi-coloured prints? <b>Contact me via Gmail</b>
</section>

<section class="card space-y-3">
  <h2 class="text-xl font-bold">Instant Estimate</h2>
  <div class="flex justify-between">
    <span>Items</span>
    <span id="items-cost">£0.00</span>
  </div>
  <div class="flex justify-between">
    <span>Shipping</span>
    <span id="shipping-cost">£0.00</span>
  </div>
  <hr>
  <div class="flex justify-between text-2xl font-bold">
    <span>Total</span>
    <span id="total-cost">£0.00</span>
  </div>
</section>

<section class="space-y-3">
  <h2 class="text-xl font-bold">Customer Information</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <input id="name" class="input" placeholder="Full name" />
    <input id="postcode" class="input" placeholder="Postcode" />
  </div>
  <textarea id="address" class="input w-full" placeholder="Full address"></textarea>
</section>

<section class="space-y-3">
  <h2 class="text-xl font-bold">Upload 3D Model</h2>
  <label class="upload-btn">
    Choose File
    <input id="file" type="file" hidden />
  </label>
  <p id="file-status" class="text-sm text-gray-400">No file selected</p>
</section>

<section class="grid grid-cols-1 sm:grid-cols-2 gap-4">
  <div>
    <h2 class="text-xl font-bold mb-2">PLA Colour</h2>
    <select id="color" class="input w-full">
      <option>Black</option>
      <option>White</option>
      <option>Gray</option>
      <option>Red</option>
      <option>Blue</option>
      <option>Yellow</option>
      <option>Green</option>
      <option>Orange</option>
    </select>
  </div>

  <div>
    <h2 class="text-xl font-bold mb-2">Quantity</h2>
    <input id="qty" type="number" min="1" value="1" class="input w-full" />
  </div>
</section>

<section>
  <h2 class="text-xl font-bold mb-2">Payment</h2>
  <div id="paypal"></div>
</section>

<footer class="text-center text-gray-500 text-sm pt-4">
  © <span id="year"></span> Mulbum3D
</footer>

</div>

<script>
document.getElementById("year").textContent = new Date().getFullYear();

const RATE_PER_MIN = 0.02;
const PLA_RATE = 0.01;
const SHIPPING_FLAT = 4.99;
const FREE_THRESHOLD = 50;

let file = null;
let cost = 0;

function updateCost(sizeMB) {
  const grams = sizeMB * 50;
  const minutes = sizeMB * 120;
  const qty = Number(document.getElementById("qty").value);

  const items = ((minutes * RATE_PER_MIN) + (grams * PLA_RATE)) * qty;
  const shipping = items >= FREE_THRESHOLD ? 0 : SHIPPING_FLAT;
  cost = items + shipping;

  document.getElementById("items-cost").textContent = "£" + items.toFixed(2);
  document.getElementById("shipping-cost").textContent = shipping === 0 ? "FREE" : "£" + shipping.toFixed(2);
  document.getElementById("total-cost").textContent = "£" + cost.toFixed(2);
}

document.getElementById("file").addEventListener("change", async e => {
  if (!e.target.files.length) return;

  const f = e.target.files[0];
  const ext = f.name.split(".").pop().toLowerCase();
  if (!["obj","3mf","amf"].includes(ext)) { 
    alert("Only OBJ, 3MF, AMF allowed"); 
    e.target.value=""; 
    return; 
  }
  if (f.size > 50*1024*1024) { 
    alert("File must be under 50MB"); 
    e.target.value=""; 
    return; 
  }

  file = f;
  document.getElementById("file-status").textContent = "Uploaded: " + f.name;
  updateCost(f.size/1024/1024);

  // Send Base64 to Netlify function for storage & Discord logging
  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result.split(',')[1];
    await fetch("/.netlify/functions/logOrder", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        name: document.getElementById("name").value,
        postcode: document.getElementById("postcode").value,
        address: document.getElementById("address").value,
        color: document.getElementById("color").value,
        qty: document.getElementById("qty").value,
        total: cost.toFixed(2),
        fileName: file.name,
        fileBase64: base64
      })
    });
  };
  reader.readAsDataURL(f);
});

document.getElementById("qty").addEventListener("input", () => { if(file) updateCost(file.size/1024/1024); });

paypal.Buttons({
  createOrder: (data, actions) => {
    if(!file){ alert("Upload a file first"); return; }
    return actions.order.create({
      purchase_units:[{ amount:{currency_code:"GBP", value:cost.toFixed(2)} }]
    });
  },
  onApprove: (data, actions) => actions.order.capture().then(details=>{
    alert("Order confirmed!");
  })
}).render("#paypal");

</script>

</body>
</html>
